# éƒ¨ç½²æ–‡æ¡£ç½‘ç«™åˆ° Cloudflare Pages
name: Deploy VitePress site to Cloudflare Pages

on:
  # åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main, master]
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œå’Œæœ€æ–°é˜Ÿåˆ—ä¹‹é—´çš„è¿è¡Œé˜Ÿåˆ—
# ä½†æ˜¯ï¼Œä¸è¦å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å…è®¸è¿™äº›ç”Ÿäº§éƒ¨ç½²å®Œæˆ
concurrency:
  group: cloudflare-pages
  cancel-in-progress: false

jobs:
  # æ„å»ºå’Œéƒ¨ç½²å·¥ä½œ
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages
    env:
      CLOUDFLARE_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME || 'cloudpaste-docs' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¦‚æœæœªå¯ç”¨ lastUpdatedï¼Œåˆ™ä¸éœ€è¦

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build with VitePress
        run: npm run docs:build

      - name: Verify build output and favicon files
        run: |
          echo "ğŸ“ æ£€æŸ¥æ„å»ºè¾“å‡ºç›®å½•..."
          ls -la docs/.vitepress/dist/
          echo ""
          echo "ğŸ¯ æ£€æŸ¥ favicon æ–‡ä»¶..."
          ls -la docs/.vitepress/dist/favicon* || echo "âŒ æ²¡æœ‰æ‰¾åˆ° favicon æ–‡ä»¶"
          ls -la docs/.vitepress/dist/apple-touch-icon.png || echo "âŒ æ²¡æœ‰æ‰¾åˆ° apple-touch-icon.png"
          ls -la docs/.vitepress/dist/android-chrome-*.png || echo "âŒ æ²¡æœ‰æ‰¾åˆ° android-chrome æ–‡ä»¶"
          echo ""
          echo "ğŸ“„ æ£€æŸ¥ index.html ä¸­çš„ favicon é…ç½®..."
          grep -n "favicon\|apple-touch-icon" docs/.vitepress/dist/index.html || echo "âŒ index.html ä¸­æ²¡æœ‰æ‰¾åˆ° favicon é…ç½®"

      - name: Check if Pages project exists
        id: check-project
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æ£€æŸ¥ Cloudflare Pages é¡¹ç›®æ˜¯å¦å­˜åœ¨..."
          PROJECT_CHECK=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" | jq -r '.result[] | select(.name=="'$CLOUDFLARE_PROJECT_NAME'") | .name')

          if [ -n "$PROJECT_CHECK" ]; then
            echo "âœ… æ‰¾åˆ°ç°æœ‰Pagesé¡¹ç›®: $CLOUDFLARE_PROJECT_NAME"
            echo "project_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°Pagesé¡¹ç›®: $CLOUDFLARE_PROJECT_NAME"
            echo "project_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pages project if not exists
        if: steps.check-project.outputs.project_exists == 'false'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "åˆ›å»º Cloudflare Pages é¡¹ç›®: $CLOUDFLARE_PROJECT_NAME..."
          # ä½¿ç”¨ wrangler åˆ›å»ºé¡¹ç›®ï¼ŒæŒ‡å®šç”Ÿäº§åˆ†æ”¯ä¸º main
          npx wrangler pages project create $CLOUDFLARE_PROJECT_NAME --production-branch=main

          if [ $? -eq 0 ]; then
            echo "âœ… æˆåŠŸåˆ›å»ºPagesé¡¹ç›®: $CLOUDFLARE_PROJECT_NAME"
          else
            echo "âŒ åˆ›å»ºPagesé¡¹ç›®å¤±è´¥ï¼Œè¯·æ£€æŸ¥é¡¹ç›®åç§°æˆ–æ‰‹åŠ¨åˆ›å»ºé¡¹ç›®"
            exit 1
          fi

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # éƒ¨ç½²åˆ°ç”Ÿäº§åˆ†æ”¯ mainï¼Œç¡®ä¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
          echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (main åˆ†æ”¯)..."
          npx wrangler pages deploy docs/.vitepress/dist --project-name=$CLOUDFLARE_PROJECT_NAME --branch=main

      - name: Display Success Information
        if: success()
        run: |
          echo "===================================================="
          echo "ğŸ‰ CloudPaste æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ° Cloudflare Pages!"
          echo "===================================================="
          echo ""
          echo "é¡¹ç›®åç§°: $CLOUDFLARE_PROJECT_NAME"
          echo "åˆ†æ”¯: main"
          echo ""
          echo "æ‚¨å¯ä»¥åœ¨ Cloudflare Pages æ§åˆ¶é¢æ¿ä¸­æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€:"
          echo "- ç™»å½• https://dash.cloudflare.com/"
          echo "- è¿›å…¥ Pages > $CLOUDFLARE_PROJECT_NAME"
          echo "===================================================="

      - name: Display Troubleshooting Info
        if: failure()
        run: |
          echo "===================================================="
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:"
          echo "1. ç¡®ä¿Cloudflareè´¦æˆ·å­˜åœ¨Pagesé¡¹ç›®"
          echo "2. éªŒè¯API Tokenæƒé™ (Pages:Edit, Account:Read)"
          echo "3. æ£€æŸ¥GitHub Secrets (CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID)"
          echo "4. ç¡®ä¿é¡¹ç›®åç§°ç¬¦åˆCloudflare Pageså‘½åè§„èŒƒ"
          echo "===================================================="
